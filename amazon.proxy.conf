# Nginx Proxy Configuration for AWS Lightsail
# NOTE: Before deploying, replace empty SECRET and token values with actual API keys
# - Line 35: proxy_set_header SECRET "YOUR_HAWK_SECRET_HERE";
# - Line 72: proxy_set_header token "YOUR_LODIBET_TOKEN_HERE";

# 定义允许的域名
map $http_origin $allowed_origin {
    default "";
    "https://hawkfestival.ph" "https://hawkfestival.ph";
    "https://lodifestival.ph" "https://lodifestival.ph";
    "http://hawkfestival.ph" "http://hawkfestival.ph";
    "http://lodifestival.ph" "http://lodifestival.ph";
}

server {
    listen 80;
    server_name _;
    
    access_log /var/log/nginx/api-proxy-access.log;
    error_log /var/log/nginx/api-proxy-error.log;

    location /api/hawk/ {
        # 检查来源是否允许
        if ($allowed_origin = "") {
            return 403;
        }

        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' $allowed_origin always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'Content-Type' always;
            add_header 'Access-Control-Max-Age' 86400 always;
            add_header 'Content-Length' 0;
            return 204;
        }

        proxy_pass https://admin.hawkplay.com/api/v5/;
        proxy_set_header Host admin.hawkplay.com;
        proxy_set_header PARTNER "HAW";
        proxy_set_header SECRET "";
        proxy_set_header Content-Type "application/json";
        
        # 隐藏后端返回的 CORS headers，防止重复
        proxy_hide_header 'Access-Control-Allow-Origin';
        proxy_hide_header 'Access-Control-Allow-Methods';
        proxy_hide_header 'Access-Control-Allow-Headers';
        proxy_hide_header 'Access-Control-Expose-Headers';
        
        # 添加我们自己的 CORS headers
        add_header 'Access-Control-Allow-Origin' $allowed_origin always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Content-Type' always;
        
        proxy_ssl_server_name on;
        proxy_redirect off;
        proxy_intercept_errors off;
    }

    location /api/lodibet/ {
        # 检查来源是否允许
        if ($allowed_origin = "") {
            return 403;
        }

        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' $allowed_origin always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'Content-Type' always;
            add_header 'Access-Control-Max-Age' 86400 always;
            add_header 'Content-Length' 0;
            return 204;
        }

        proxy_pass https://www.ldb789.com/expose_api/player/;
        proxy_set_header Host www.ldb789.com;
        proxy_set_header merchantCode "lodibet";
        proxy_set_header token "";
        proxy_set_header lang "EN";
        proxy_set_header Content-Type "application/json";
        
        # 隐藏后端返回的 CORS headers，防止重复
        proxy_hide_header 'Access-Control-Allow-Origin';
        proxy_hide_header 'Access-Control-Allow-Methods';
        proxy_hide_header 'Access-Control-Allow-Headers';
        
        # 添加我们自己的 CORS headers
        add_header 'Access-Control-Allow-Origin' $allowed_origin always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Content-Type' always;
        
        proxy_ssl_server_name on;
        proxy_redirect off;
        proxy_intercept_errors off;
    }

    location /health {
        return 200 "OK\n";
        add_header Content-Type text/plain;
    }
}